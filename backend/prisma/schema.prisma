datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id       Int    @id @default(autoincrement())
  username String @unique
  password String
}

model Connection {
  id                Int              @id @default(autoincrement())
  platform          String
  storeUrl          String
  accessToken       String?
  consumerKey       String?
  consumerSecret    String?
  lastSync          DateTime?
  syncEnabled       Boolean          @default(true)
  defaultLocationId String?
  InventoryCache    InventoryCache[]
  SalesLog          SalesLog[]
  SyncError         SyncError[]

  @@unique([platform, storeUrl])
}

model InventoryCache {
  id           Int        @id @default(autoincrement())
  connectionId Int
  sku          String
  quantity     Int
  connection   Connection @relation(fields: [connectionId], references: [id])

  @@unique([connectionId, sku], name: "connectionId_sku")
}

model SalesLog {
  id            Int        @id @default(autoincrement())
  connectionId  Int
  orderId       String
  prokipSellId  String?
  operationType String     @default("webhook") // "webhook", "sale", "purchase"
  timestamp     DateTime   @default(now())
  connection    Connection @relation(fields: [connectionId], references: [id])
}

model ProkipConfig {
  id         Int    @id @default(1)
  token      String
  apiUrl     String
  locationId String
}

model SyncError {
  id           Int        @id @default(autoincrement())
  connectionId Int
  orderId      String?
  errorType    String
  errorMessage String
  errorData    Json?
  createdAt    DateTime   @default(now())
  resolved     Boolean    @default(false)
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([resolved])
  @@index([createdAt])
}
