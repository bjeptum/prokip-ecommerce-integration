<!DOCTYPE html>
<html lang="en">
<head>
  <title>Prokip Setup</title>
  <link rel="stylesheet" href="/public/style.css">
</head>
<body>
  <h1>Choose Product Setup Method</h1>
  <p>Helper: Choose how youâ€™d like to set up products for syncing.</p>
  <label>
    <input type="radio" name="choice" value="pull"> Use products from my online store (Pull)
  </label><br>
  <label>
    <input type="radio" name="choice" value="push"> Use products from Prokip (Push)
  </label><br>
  <button onclick="saveChoice()">Save and Continue</button>
  <div id="flow"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const platform = urlParams.get('platform');

    function saveChoice() {
      const choice = document.querySelector('input[name="choice"]:checked')?.value;
      if (!choice) return alert('Choose an option');
      fetch('/api/setup', { method: 'POST', body: `platform=${platform}&choice=${choice}` })
        .then(res => res.text())
        .then(text => {
          alert(text);
          if (choice === 'pull') loadPull();
          else loadPush();
        });
    }

    function loadPull() {
      fetch('/api/pull', { method: 'POST', body: `platform=${platform}` })
        .then(res => res.json())
        .then(matches => {
          const div = document.getElementById('flow');
          div.innerHTML = '<h2>Pull Products - Matching</h2><ul>';
          matches.forEach(p => {
            div.innerHTML += `<li>SKU: ${p.sku}, Name: ${p.name} <span class="badge">${p.status}</span></li>`;
          });
          div.innerHTML += '</ul><button onclick="alert(\'Sync activated!\')">Confirm and Activate Sync</button>';
        });
    }

    function loadPush() {
      const div = document.getElementById('flow');
      div.innerHTML = '<h2>Push Products - Readiness Check</h2>';
      div.innerHTML += '<form id="pushForm">';
      div.innerHTML += 'Product: T-Shirt (SKU: shirt1)<br>';
      div.innerHTML += 'Price: <input name="price_shirt1" value="20"><br>';
      div.innerHTML += 'Image URL: <input name="image_shirt1" value=""><br>';
      div.innerHTML += '<button type="button" onclick="submitPush()">Preview and Publish</button>';
      div.innerHTML += '</form><div id="preview"></div>';
    }

    function submitPush() {
      const form = document.getElementById('pushForm');
      const formData = new FormData(form);
      const body = new URLSearchParams(formData).toString();
      fetch('/api/push', { method: 'POST', body, headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })
        .then(res => res.json())
        .then(products => {
          const prev = document.getElementById('preview');
          prev.innerHTML = '<h3>Preview</h3><ul>';
          products.forEach(p => {
            prev.innerHTML += `<li>SKU: ${p.sku}, Ready: ${p.ready ? 'Yes' : 'No (fix above)'}</li>`;
          });
          prev.innerHTML += '</ul>';
          if (products.every(p => p.ready)) prev.innerHTML += '<button onclick="alert(\'Published! Sync enabled.\')">Confirm Publish</button>';
        })
        .catch(err => alert('Error: This product needs a price or image.'));
    }
  </script>
</body>
</html>